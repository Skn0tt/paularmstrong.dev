---
import AuthorMeta from '~/components/AuthorMeta.astro';
import Base from '~/layouts/Base.astro';
import Prose from '~/components/Prose.astro';

const posts = (await Astro.glob('../../../blog/*.{md,mdx}')).sort(
	(a, b) => new Date(b.frontmatter.pubDate).valueOf() - new Date(a.frontmatter.pubDate).valueOf()
);
const dateFormatter = new Intl.DateTimeFormat('en-US', { dateStyle: 'medium' }).format;
---

<Base title="Blog">
	<div class="pb-12">
		<Prose>
			<h1>Blog</h1>
			<p>
				Rambling, ranting, and ravingâ€¦ But mostly just whatever seems important in the moment about JavaScript, frontend
				development, and life surrounding me.
			</p>
		</Prose>
	</div>
	<section>
		<AuthorMeta id="author" />
		<ul class="flex flex-col gap-4">
			{
				posts.map((post) => {
					const { draft, pubDate, title, description, heroImage } = post.frontmatter;
					if (import.meta.env.PROD && draft) {
						return null;
					}

					const filename = post.file.split('/blog/')[1].replace(/\.mdx?$/, '');
					const match = filename?.match(/^(?<year>\d+)-(?<month>\d+)-(?<day>\d+)-(?<slug>.+)$/);
					if (!match) {
						return null;
					}
					const slug = `/blog/${Object.values(match.groups || {}).join('/')}`;
					const date = dateFormatter(new Date(pubDate));

					return (
						<li
							class="mb-4 grid grid-cols-6 gap-4"
							itemscope
							itemprop="blogPost"
							itemtype="http://schema.org/Article"
							itemref="author"
						>
							<time
								class="text-right leading-8 text-slate-600 dark:text-slate-300"
								datetime={date}
								itemprop="datePublished"
								content={date}
							>
								{date}
							</time>
							<div class="col-span-5">
								<h2 class="text-purple-600 no-underline hover:underline hover:decoration-4 hover:underline-offset-4 dark:text-purple-400">
									<a
										class="bg-gradient-to-br from-blue-700 to-purple-600 bg-clip-text text-2xl font-bold text-transparent dark:from-blue-400 dark:to-purple-400"
										href={slug}
										itemprop="url"
									>
										<span itemprop="name headline">{title}</span>
										{draft ? <sup class="text-sm text-red-400">(draft)</sup> : null}
										{heroImage ? (
											<div class="my-2">
												<Prose>
													<picture>
														{(Array.isArray(heroImage?.src) ? heroImage.src : [heroImage.src]).map((img) => (
															<source srcset={img} type={`image/${img.split('.')[img.split('.').length - 1]}`} />
														))}
														<img
															itemprop="image"
															class="!mt-0 w-full max-w-none"
															src={heroImage[0]}
															alt=""
															width={heroImage.width}
															height={heroImage.height}
														/>
													</picture>
												</Prose>
											</div>
										) : null}
									</a>
								</h2>
								<Prose>
									<p>{description}</p>
								</Prose>
							</div>
						</li>
					);
				})
			}
		</ul>
	</section>
</Base>
